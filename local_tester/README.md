# 使い方

## インストール
```
cargo install --path .
```

`ahc` というコマンドが使えるようになる。

## ディレクトリ構成

コンテスト用のディレクトリを別に作成し、以下のような構成にする。

```
ahc.toml
all/
├── in.csv	
└── in/
    ├── 0000.txt
    └── 0001.txt
```

`all` はテストセットの名称で自由につけることが出来る。`easy`、`hard` など、複数のテストセットに分けても良い。
`in.csv` は以下のような csv ファイル。

```
file,seed,N
0000,0,10
0001,1,20
```

`file` と `seed` は必須で、他は入力サイズなどの特徴量を任意で記述。

`ahc.toml` は設定ファイル

- parallel: 並列実行数
- default_set: テストセット名を指定しなかった場合のデフォルト名
- listen: 実行結果閲覧用のアドレスとポート
- tester: テスタープログラムのパス
- default_key: 実行結果閲覧時にデフォルトで表示される値
- vis: ビジュアライザへのパス
- vis_ext: ビジュアライズ結果の拡張子
- show_details: 各テストケース毎の結果が表示される上限テストケース数(大きくしすぎると重い)

## テスター
`tester.rs` がサンプル実装

`tester cmd input output vis` という形式で引数4つで実行されるので、`cmd` のプログラムを入力ファイル `input` 相手に実行し、標準出力を `output` に、ビジュアライズ結果を `vis` に書き出す。
標準エラーはプログラムの標準エラー出力をそのまま吐き、実行結果(AC/WAなど)、実行時間、スコアを

```
!log status AC
!log time 1.950
!log score 123456
```

という形式で標準エラーに追記する。

## 実行コマンド

### ahc run
```
ahc run <src>
```
という形式で実行すると、`<src>` がコンパイルされてデフォルトテストセットに対して実行される。
Rust、C++、PyPy3以外には対応していない。
以下のオプションが指定できる。

- `-m <msg>`: 実行結果に付随するメッセージを付与
- `-i <input>`: テストセット(`all`) やテストケース(`all/in/0000.txt`)を指定すると、指定されたテストに対して実行される
- `-p <num>`: 並列実行数を指定

テストケースに対して実行した場合は標準エラーがそのまま表示される。
テストセットに対して実行した場合は合計スコア等が表示され、実行結果が保存される。

### ahc start
実行結果閲覧用のサーバーを起動する。
ブラウザでアクセスすることで実行結果を閲覧できる。

### ahc best
各テストケースに対してこれまでの実行におけるベスト解を集計し、`<testset>/best` というディレクトリにベスト解が保存される。
`-i <input>` でテストセットを指定できる。

### ahc clean
実行結果の詳細情報(標準出力,標準エラー出力,ビジュアライズ結果)を削除して容量を削減する。
`-i <input>` でテストセットを指定できる。

## 実行結果

解答プログラムは標準エラーに `!log key val` という形式で出力することにより、反復回数など、追加の情報を保存できる。
テストセットに対する実行毎に `<testset>/run` ディレクトリに 0 からの連番IDのディレクトリが作成され、ソースコード、実行結果の詳細(`result.toml`)、標準出力(`out`)、標準エラー(`err`)、ビジュアライズ結果(`vis`)が保存される。
データベースは使用していないので不要な実行結果はディレクトリをそのまま削除すれば良い。

## 結果の閲覧
`ahc start` を実行してからブラウザでアクセスすることで実行結果一覧が表示される。

クエリパラメータで `?set=` を指定することでデフォルト以外のテストセットが表示される。

`Key` を変更することで相対スコアや実行時間など、他の情報を表示できる。
相対スコアは以下の4種類。

- `score_max`: 自分/最大
- `score_min`: 最小/自分
- `score_rank_max`: 大きい順での自分の順位/人数
- `score_rank_min`: 小さい順での自分の順位/人数

テストケースに対する実行結果は保存されず、最新の結果のみ左上の `Recent` のリンクから確認できる。
`Filter` 欄に入力の特徴量に関する制約 (`N<=100`など) を書くとテストケースの絞り込みが出来る。

現在実行途中の結果もリロードすると随時更新される。

### 各カラムの説明

- id: 実行結果に振られる連番のID。クリックするとビジュアライズ結果の一覧が表示される。
- sid: ソースコードの中身が同じだと同じ番号になる。
- msg: 実行時に付与したメッセージ(無い場合はファイル名)。クリックすると編集できる。
- src: ソースコードのファイル名。クリックすると表示できる。
- sum/avg: 現在表示しているKeyの和と平均
- `0000` など: 各テストケースに対するKey値。クリックするとビジュアライザが起動する。

## 結果の比較
`/list?run_ids=0,1` というページにアクセスすることで、複数の実行結果の比較をビジュアライズ結果の一覧を見ながら行うことが出来る。
